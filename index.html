<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="bootstrap.min.css" rel="stylesheet">
  <title>Conversor de Modeas - AlpineJS</title>
  <script defer src="alpine.min.js"></script>
  <!-- <script src="components.js"></script> -->
</head>
<body>
  <script>


    function CambioUtil() {

      const taxaCambioCache = new Map();
      const moedasCache = [];
      return {
        async moedas() {
          if (moedasCache.length) {
            return moedasCache;
          }

          try {

            /**@type {Object.<string, string>} */
            const moedas = await fetch('https://cdn.jsdelivr.net/npm/@fawazahmed0/currency-api@latest/v1/currencies.json')
              .then(response => response.json());


            Object.entries(moedas).forEach(([chave, nome]) => {
              if (!nome) return;
              moedasCache.push({ chave, nome });
            });

            console.log('Moedas atualizadas', moedasCache);
            return moedasCache;
          } catch (error) {
            console.error('Erro ao buscar moedas', error);
            return [];
          }
        },

        /**
         * @param {string} moedaOrigem 
         * @param {string} moedaDestino 
         */
        async taxaCambio(moedaOrigem, moedaDestino) {
          moedaOrigem = moedaOrigem.toLowerCase();
          moedaDestino = moedaDestino.toLowerCase();

          if (taxaCambioCache.has(moedaOrigem)) {
            return taxaCambioCache.get(moedaOrigem)[moedaDestino] ?? 0;
          }

          try {
            const json = await fetch(`https://cdn.jsdelivr.net/npm/@fawazahmed0/currency-api@latest/v1/currencies/${moedaOrigem.toLowerCase()}.json`)
              .then(response => response.json());

            taxaCambioCache.set(moedaOrigem, json[moedaOrigem]);

            const taxaCambio = json[moedaOrigem]?.[moedaDestino] ?? 0;
            return taxaCambio;
          } catch (error) {
            console.error('Erro ao buscar taxa de câmbio', error);
            return 0;
          }
        }
      }
    }

    //RF 5. Funções Puras e Imutabilidade:


    /**
    * @param {number} numero
    * @returns {boolean}
    */
    function numeroMaiorQueZero(numero) {
      return !isNaN(numero) && numero > 0;
    }

    /**
      * @param {number} valor 
      * @param {string} moeda 
      * @returns {string}
      */
    function formatarValor(valor, moeda) {
      try {
        return Number(valor).toLocaleString('pt-br', { style: "currency", currency: String(moeda) });
      } catch {
        return Number(valor).toLocaleString('pt-br', { style: "decimal" });
      }
    }

    /**
    * @param {any} valor
    * @returns {boolean}
    */
    function ehVerdadeiro(valor) {
      return !!valor;
    }


    //RF 2. Taxa de Câmbio e 3. Conversão de Moeda:
    /**
    * @param {number} valor
    * @param {number} taxaCambio
    * @returns {number}
    */
    function converterValorTaxaCambio(valor, taxaCambio) {
      return valor * taxaCambio;
    }



    function conversorMoedasData() {
      return {
        valor: null,
        taxaCambio: 0,
        moedaOrigem: 'BRL',
        moedaDestino: 'BRL',
        taxaCambioUtil: CambioUtil(),
        moedas: [
          {
            chave: 'BRL',
            nome: 'Real',
          },
          {
            chave: 'USD',
            nome: 'Dolar',
          },
          {
            chave: 'EUR',
            nome: 'Euro',
          }
        ],
        init() {
          this.$watch('moedaOrigem', this.aoAtualizarCampos.bind(this));
          this.$watch('moedaDestino', this.aoAtualizarCampos.bind(this));
          this.$watch('valor', this.aoAtualizarCampos.bind(this));

          this.aoAtualizarCampos();
          this.buscarMoedas();
        },
        aoAtualizarCampos() {
          this.definirMoedaDestinoValida();
          this.atualizarTaxaCambio();
        },
        async buscarMoedas() {
          this.moedas = await this.taxaCambioUtil.moedas();
        }
        ,
        async atualizarTaxaCambio() {
          this.taxaCambio = await this.taxaCambioUtil.taxaCambio(this.moedaOrigem, this.moedaDestino);
          console.log('Taxa de câmbio atualizada', this.taxaCambio);
        },
        definirMoedaDestinoValida() {
          if (this.moedaDestino == this.moedaOrigem) {
            this.moedaDestino = this.moedasDisponiveisDestino[0].id;
          }
        },
        /**
        * @param {string} moeda 
        * @returns {boolean}
        */
        moedaOrigemValida(moeda) {
          return this.moedas.some(moedaDisponivel => moedaDisponivel.chave === moeda);
        },
        // RF 4. Validação:
        /**
        * @param {number} valorOrigem
        * @param {number} taxaCambio 
        * @param {number} moedaOrigem 
        * @param {number} moedaDestino 
        * @returns {boolean}
        */
        validarInputs(valorOrigem, taxaCambio, moedaOrigem, moedaDestino) {
          // RF 6. Funções de Ordem Superior:
          return [
            [valorOrigem, taxaCambio].every(numeroMaiorQueZero),
            [moedaOrigem, moedaDestino].every(this.moedaOrigemValida.bind(this))
          ].every(ehVerdadeiro);
        },
        get valido() {
          return this.validarInputs(this.valor, this.taxaCambio, this.moedaOrigem, this.moedaDestino);
        },
        get valorFormatado() {
          if (!this.valido) return formatarValor(0, this.moedaOrigem);
          return formatarValor(this.valor, this.moedaOrigem);
        },
        get valorConvertido() {
          if (!this.valido) return 0;

          return converterValorTaxaCambio(this.valor, this.taxaCambio);
        },
        get valorConvertidoFormatado() {
          if (!this.valido) return formatarValor(0, this.moedaDestino);
          return formatarValor(this.valorConvertido, this.moedaDestino);
        },
        get moedasDisponiveisOrigem() {
          return this.moedas.map(moeda => ({ id: moeda.chave, nome: moeda.nome }));
        },
        get moedasDisponiveisDestino() {
          return this.moedasDisponiveisOrigem.filter(moeda => moeda.id !== this.moedaOrigem);
        }
      }
    }


  </script>
  <div style="height: 100vh; width: 100vw; background-color: #0a2c4b;"
    class=" p-4 d-flex align-items-center justify-content-center">
    <div class="card" style="max-width: 600px; width: 100%;" x-data="conversorMoedasData()">
      <div class="card-body">
        <h5 class="card-title text-center">Conversor de Moedas</h5>
        <p class="card-text text-center">Desenvolvido por: Álison Loffi.</p>
        <div class="mt-5 d-flex flex-column gap-3">
          <div class="form-floating">
            <input x-model.number="valor" type="number" class="form-control" id="inputValor">
            <label for="inputValor">Valor</label>
          </div>
          <div class="row ">
            <div class="col">
              <div class="form-floating ">
                <select x-model="moedaOrigem" class="form-select" id="deInput" aria-label="">
                  <template x-for="(moeda) in moedasDisponiveisOrigem">
                    <option :value="moeda.id" x-text="moeda.nome"></option>
                  </template>
                </select>
                <label for="deInput">De: </label>
              </div>
            </div>
            <div class="col">
              <div class="form-floating ">
                <select x-model="moedaDestino" class="form-select" id="paraInput" aria-label="">
                  <template x-for="moeda in moedasDisponiveisDestino">
                    <option :value="moeda.id" x-text="moeda.nome"></option>
                  </template>
                </select>
                <label for="paraInput">Para: </label>
              </div>
            </div>
          </div>
          <div class="row align-items-center">
            <div class="col-5">
              <div class="border border-secondary-subtle rounded p-2" x-text="valorFormatado"></div>
            </div>
            <div class="col">
              <div class="text-center fw-bold fs-3"> = </div>
            </div>
            <div class="col-5">
              <div class="border border-secondary-subtle rounded p-2" x-text="valorConvertidoFormatado"></div>
            </div>
          </div>
          <div />
        </div>
      </div>
    </div>
    <script src="https://code.jquery.com/jquery-3.6.1.js"
      integrity="sha256-3zlB5s2uwoUzrXK3BT7AX3FyvojsraNFxCc2vC/7pNI=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM"
      crossorigin="anonymous"></script>
</body>
</html>